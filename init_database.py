#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
"""

import os
import sys
import logging
from dotenv import load_dotenv

# --- –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ---

# –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫—É 'src' –≤ –ø—É—Ç—å Python
sys.path.append(os.path.join(os.path.dirname(__file__), 'src'))

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# ======================================================================
# --- –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ---
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è.
# Python —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã 'import *' –Ω–∞—Ö–æ–¥–∏–ª—Å—è –∑–¥–µ—Å—å, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏.
from src.models import *
# ======================================================================

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def initialize_database():
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    """
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")
    
    try:
        # --- –ò–º–ø–æ—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        logger.info("–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º 'app' –∏ 'db' –∏–∑ 'src.main'...")
        from main import app, db
        logger.info("–ò–º–ø–æ—Ä—Ç 'app' –∏ 'db' —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.")

        # --- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ —Ç–∞–±–ª–∏—Ü ---
        with app.app_context():
            logger.info("–í—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Flask.")
            
            db_uri = app.config.get('SQLALCHEMY_DATABASE_URI')
            logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è URI –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {db_uri}")

            logger.info("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ db.create_all() –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü...")
            db.create_all()
            
            logger.info("‚úÖ –ö–æ–º–∞–Ω–¥–∞ db.create_all() —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞.")

    except ImportError as e:
        logger.error(f"‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å 'app', 'db' –∏–ª–∏ 'models'.")
        logger.error(f"   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª—ã 'src/main.py' –∏ 'src/models.py' —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.")
        logger.error(f"   –¢–µ–∫—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—à–∏–±–∫–∏: {e}")
        sys.exit(1)

    except Exception as e:
        logger.error(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î.")
        logger.error(f"   –¢–µ–∫—Å—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—à–∏–±–∫–∏: {e}", exc_info=True)
        sys.exit(1)

    logger.info("üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")


if __name__ == "__main__":
    initialize_database()
